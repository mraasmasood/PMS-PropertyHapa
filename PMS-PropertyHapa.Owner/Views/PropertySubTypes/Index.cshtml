@model PMS_PropertyHapa.Models.DTO.PropertySubTypeDto

@{
    ViewData["Title"] = "Property Subtypes";
    Layout = "~/Views/Shared/ManagePropertyforOwnerLayout.cshtml";
}

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.datatables.net/1.11.3/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@10"></script>

<div class="page-body">
    <div class="container-fluid">
        <div class="page-title">
            <div class="row">
                <div class="col-12">
                    <h3>Property Subtypes List</h3>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <a href="/PropertySubTypes/AddPropertySubType" class="btn btn-success">Add New Property Subtype</a>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table" id="propertySubTypesTable">
                                <thead>
                                    <tr>
                                        <th>Property Subtype ID</th>
                                        <th>Property Type ID</th>
                                        <th>Property Subtype Name</th>
                                        <th>Icon SVG</th>
                                        <th>Status</th>
                                        <th>Added Date</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Content will be loaded by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(document).ready(function () {
        fetchData();

        function fetchData(search = '', page = 1, sortField = 'PropertySubTypeId', sortOrder = 'asc') {
            var tenantId = localStorage.getItem('userId');

            $.ajax({
                url: `/PropertySubTypes/GetPropertySubTypeData?tenantId=${encodeURIComponent(tenantId)}`,
                type: 'GET',
                dataType: 'json',
                success: function (response) {
                    populateTable(response.data);
                   
                },
                error: function (xhr, status, error) {
                    console.error('Error fetching property subtypes:', error);
                }
            });
        }

        function populateTable(data) {
            var table = $('#propertySubTypesTable').DataTable();
            table.clear(); 

            data.forEach(function (row) {
                table.row.add([
                    row.PropertySubTypeId,
                    row.PropertyTypeId,
                    row.PropertySubTypeName,                    
                    '<img src="data:image;base64,' + row.Icon_SVG + '" height="50px" width="100px" />',
                    row.Status ? 'Active' : 'Inactive',
                    row.AddedDate ? new Date(row.AddedDate).toLocaleDateString() : '-----',
                    `<a href="/PropertySubTypes/EditPropertySubType?propertySubTypeId=${row.PropertySubTypeId}" class="btn btn-sm btn-success" style="margin-right: 5px; display: inline-block;">Edit</a>` +
                    `<button class="btn btn-sm btn-danger" onclick="deletePropertySubType('${row.PropertySubTypeId}')" style="display: inline-block;">Delete</button>`
                ]).draw(false);
            });
        }

        function deletePropertySubType(propertySubTypeId) {
            Swal.fire({
                title: 'Are you sure?',
                text: 'Once deleted, you will not be able to recover this property subtype!',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Yes, delete it!'
            }).then((result) => {
                if (result.isConfirmed) {
                    $.ajax({
                        url: `/PropertySubTypes/Delete?propertysubTypeId=${encodeURIComponent(propertySubTypeId)}`,
                        type: 'DELETE',
                        success: function (response) {
                            if (response.success) {
                                fetchData(); 
                                Swal.fire('Deleted!', 'The property subtype has been deleted.', 'success');
                            } else {
                                Swal.fire('Error!', response.message, 'error');
                            }
                        },
                        error: function (xhr, status, error) {
                            Swal.fire('Error!', 'There was an issue deleting the property subtype.', 'error');
                        }
                    });
                }
            });
        }

        $('#propertySubTypesTable').DataTable({
            "paging": true,
            "ordering": true,
            "info": true,
            "searching": true,
            "destroy": true, 
        });
    });
</script>

